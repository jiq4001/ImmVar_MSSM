---
title: "Immvar_MSSM"
author: "Jingjing Qi"
date: "July 4, 2020; updated `r Sys.Date()`"
output:
  html_document:
    toc: true
    code_folding: hide
    theme: yeti
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(variancePartition)
library(tidyverse)
```

## Package variancePartition

VariancePartition is a tool for test of variance in gene expression analysis, aims for inference, assumes linear relationship between response and predictors. 

Thoughts of variancePartition vs other methods:
Linear regression or Anova assumes  homoscadacity of the residual variance, which in general is not the case in gene expression data.

PCA: unsupervised clustering based on variances explained in overall gene expression matrix without in consideration of meta data 

variancePartition use mixed linear model offers a way to model  variance explained by continuous and categorical  meta characteristics. 

## Dataset: Immvar

### Clean Meta data
```{r}
meta.data <- read.delim("~/Desktop/Immvar_MSSM/GSE56035_series_matrix.txt", skip = 28, header = F, nrows = 38)
meta.data.colname <- meta.data[, 1] 
meta.data <- meta.data[, -1]
meta.data.ls <- lapply(1:nrow(meta.data), function(x){
  data.frame(t(meta.data[x, ]))
})
meta.data.ls <- do.call(cbind, meta.data.ls)
colnames(meta.data.ls) <- meta.data.colname

lapply(1:ncol(meta.data.ls), function(x){
  length(unique(meta.data.ls[, x])) != 1
}) %>% unlist() -> col_w_diff

meta.data.ls <- meta.data.ls[, col_w_diff]
filt.col <- colnames(meta.data.ls)[grep(".*_ch.*", colnames(meta.data.ls))]
meta.data.ls <- meta.data.ls[, filt.col]
```
Read in meta data section from "GSE56035_series_matrix.txt", link[https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE56035].
Remove metadata column with no difference among all samples. 
Checked remained columns: `r colnames(meta.data.ls)`, further remove "!Sample_supplementary_file", "!Sample_relation", "!Sample_last_update_date", "!Sample_submission_date", ....
Only kept `r filt.col`
```{r}
#summary(meta.data.ls)
colnames(meta.data.ls) <- c("source", "age", "sex", "cell_type", "batch", "inc_marker", "exc_marker", "marker")
meta.data.ls$source <- factor(meta.data.ls$source, 
                              levels = unique(meta.data.ls$source), 
                              labels = c("CD4", "Mono"))
meta.data.ls$age <- as.numeric(meta.data.ls$age)

meta.data.ls$sex <- factor(ifelse(grepl(".*female", meta.data.ls$sex, ignore.case = T), "female", "male"))
meta.data.ls$batch <- factor(as.character(meta.data.ls$batch))
meta.data.ls <- meta.data.ls[, c("source", "age", "sex", "batch")]
str(meta.data.ls)
```
Further cleaning... relabel column, rename level, drop column with duplicated info. remained meta columns: `r colnames(meta.data.ls)`
Without considering interaction, meta data covariates appears to be overall ballanced in levels, no positivity issue noticed. 

### Read in Expression Data
```{r, eval=F}
exp.data <- read.delim("~/Desktop/Immvar_MSSM/GSE56035_series_matrix.txt", skip = 67, header = T)
rownames(exp.data) <- exp.data[, 1]
exp.data <- exp.data[, -1]
exp.data <- exp.data[1:(nrow(exp.data)-1), ]
dim(exp.data)
```

## Running variancePartition 

### Full dataset, $~ age + source + sex + batch$    

```{r, eval=F}
form <- ~ age + (1|source) + (1|sex) + (1|batch)
varPart <- fitExtractVarPartModel( exp.data, form, meta.data.ls )
#str(varPart)
#save(varPart, file = "varPart.rda")
```
    
    
```{r}
load("~/Desktop/Immvar_MSSM/varPart.rda")
vp <- sortCols( varPart )
p1 <- plotVarPart( vp )+
  labs(title = "Overall Variancr Explained by Meta Vars")
p2 <- plotPercentBars(vp[order(varPart$sex, decreasing=TRUE),][1:10,] )+
  labs(title = "Top 10 Features Variance Explained by Sex")
gridExtra::grid.arrange(p2, p1, nrow = 1)
```
    
It appears that most of the variance in the gene expression are explained by celltype, and unadjusted factors /random errors. Which is reasonable since CD4 and Monocytes are distict immune cell phenotypes. Though Sex was able to explain the variances in some features, which might worth look into. 

Also, it might make sense to look into independent cell source type. For example:CD4

### CD4 subset, $~ age + sex + batch$    

```{r, eval=F}
form_sub <- ~ age + (1|sex) + (1|batch)
sub_set <- exp.data[, meta.data.ls$source == "CD4"]
sub_meta <- meta.data.ls[meta.data.ls$source == "CD4", ] 
varPart_cd4 <- fitExtractVarPartModel( sub_set, form_sub, 
                                   sub_meta)

#save(varPart_cd4, file = "varPart_cd4.rda")

plotVarPart( vp_cd4 )
plotPercentBars( vp[1:10,] )
```
    

```{r}
load("~/Desktop/Immvar_MSSM/varPart_cd4.rda")
vp_cd4 <- sortCols( varPart_cd4 )
p1 <- plotVarPart( vp_cd4 )+
  labs(title = "Overall Variancr Explained by Meta Vars in CD4")
p2 <- plotPercentBars(vp_cd4[order(vp_cd4$age, decreasing=TRUE),][1:10,] )+
  labs(title = "Top 10 Features Variance Explained by Sex in CD4")
gridExtra::grid.arrange(p2, p1, nrow = 1)
```
    
It appears that most of the variance in the gene expression are explained by unadjusted factors /random errors, followed by Sex, then by Age as a factor. 

List of Top 10 Features Sorted by Variance Explained by Age adjusted for Sex, Batch in CD4
```{r}
varPart_cd4[order(varPart_cd4$age, decreasing=TRUE),][1:10,]%>%
  data.frame()%>%
  kableExtra::kable(digits = 3)%>%
  kableExtra::kable_styling()
```
 
```{r, eval=F}
i <- which.max( varPart_cd4$age )
title <- rownames(sub_set)[i]
GE <- data.frame( expression = as.numeric(t(sub_set[i,])), 
                  age = sub_meta$age)
#str(GE)
ggplot(GE, aes(age, expression))+
  geom_point()+
  geom_smooth(method = "lm")
```

